<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ù…Ù‡Ø§Ø±Ø§Øª Ù„ØºØªÙŠ Ø§Ù„Ù…Ù…ØªØ¹Ø©</title>

  <style>
    :root{
      --bg:#f6f7ff;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;

      --p1:#5b5bd6;
      --p2:#7c3aed;

      --btnVideo:#4f46e5;
      --btnQuiz:#16a34a;
      --btnBack:#6b5bd6;

      --shadow: 0 12px 28px rgba(0,0,0,.12);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Cairo", system-ui, -apple-system, Segoe UI, Tahoma, Arial;
      background: radial-gradient(1200px 600px at 80% 0%, rgba(124,58,237,.18), transparent 60%),
                  radial-gradient(1000px 500px at 10% 20%, rgba(91,91,214,.16), transparent 55%),
                  var(--bg);
      color:var(--ink);
    }

    .wrap{max-width:1100px;margin:0 auto;padding:14px 14px 26px}

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, var(--p1), var(--p2));
      color:#fff;
      box-shadow: var(--shadow);
      position:sticky;
      top:0;
      z-index:30;
    }
    .topbar .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      line-height:1.15;
    }
    .topbar h1{
      margin:0;
      font-size:20px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .topbar p{
      margin:0;
      font-size:12px;
      opacity:.95;
    }
    .topbar .actions{
      display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;
    }
    .chipbtn{
      border:none;
      cursor:pointer;
      padding:10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.18);
      color:#fff;
      font-weight:800;
      font-size:13px;
      backdrop-filter: blur(8px);
      transition:.15s;
      white-space:nowrap;
    }
    .chipbtn:active{transform:scale(.98)}
    .chipbtn.secondary{background:rgba(255,255,255,.12)}
    .chipbtn.home{background:rgba(255,255,255,.22)}

    /* Screen sections */
    .screen{margin-top:14px}
    .hint{
      background:#ffffffcc;
      border:1px solid rgba(0,0,0,.06);
      padding:12px 14px;
      border-radius: 16px;
      color:var(--muted);
      font-weight:700;
      box-shadow: 0 8px 20px rgba(0,0,0,.06);
    }

    /* Skills buttons list (mobile friendly) */
    .skillsGrid{
      margin-top:14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
    }
    .skillBtn{
      border:none;
      cursor:pointer;
      padding:14px 16px;
      border-radius: 999px;
      background:#fff;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      font-weight:900;
      font-size:15px;
      color:#2b2b2b;
      transition:.15s;
      max-width: 100%;
    }
    .skillBtn:active{transform:scale(.98)}
    .skillBtn.active{
      background: linear-gradient(135deg, rgba(91,91,214,.95), rgba(124,58,237,.95));
      color:#fff;
    }

    /* Skill viewer */
    .viewer{
      margin-top:14px;
      display:none;
    }
    .viewer.show{display:block}

    .skillCard{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      border:1px solid rgba(0,0,0,.06);
    }

    .skillHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      background: linear-gradient(135deg, rgba(91,91,214,.12), rgba(124,58,237,.12));
    }
    .skillHeader h2{
      margin:0;
      font-size:18px;
      font-weight:900;
      color:#2b2b2b;
    }
    .smallnote{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
    }

    .skillImgWrap{
      background:#f3f4ff;
      padding:14px;
    }
    .skillImg{
      width:100%;
      height:auto;
      border-radius: 18px;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      cursor: zoom-in;
      transition:.15s;
    }
    .skillImg:active{transform:scale(.995)}

    /* Buttons UNDER the image (Ù…Ø«Ù„ Ù‚Ø¨Ù„) */
    .btnRow{
      display:flex;
      gap:10px;
      padding:14px;
      flex-wrap:wrap;
      justify-content:center;
      background:#fff;
    }
    .bigbtn{
      border:none;
      cursor:pointer;
      padding:14px 16px;
      border-radius: 16px;
      font-weight:900;
      font-size:15px;
      min-width: 150px;
      box-shadow: 0 10px 20px rgba(0,0,0,.10);
      transition:.15s;
      color:#fff;
    }
    .bigbtn:active{transform:scale(.98)}
    .bigbtn.video{background: var(--btnVideo)}
    .bigbtn.quiz{background: var(--btnQuiz)}
    .bigbtn.back{background: var(--btnBack)}
    .bigbtn.gray{background:#111827}

    /* Footer signature */
    .footer{
      margin-top:14px;
      text-align:center;
      color:#374151;
      font-weight:900;
      opacity:.9;
    }

    /* Modals */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:80;
      padding:16px;
    }
    .modalOverlay.show{display:flex}
    .modal{
      width:min(920px, 100%);
      background:#fff;
      border-radius: 22px;
      box-shadow: 0 22px 60px rgba(0,0,0,.28);
      overflow:hidden;
      position:relative;
    }
    .modalTop{
      padding:12px 14px;
      background: linear-gradient(135deg, var(--p1), var(--p2));
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalTop b{font-size:14px}
    .closeBtn{
      border:none;
      cursor:pointer;
      padding:8px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.18);
      color:#fff;
      font-weight:900;
    }
    .closeBtn:active{transform:scale(.98)}
    .modalBody{padding:14px}

    /* Video small window (Ù…Ø«Ù„ Ù‚Ø¨Ù„) */
    .videoFrame{
      width:100%;
      aspect-ratio: 16/9;
      border-radius: 16px;
      overflow:hidden;
      background:#000;
      box-shadow: 0 10px 22px rgba(0,0,0,.12);
    }
    .videoFrame iframe{
      width:100%;
      height:100%;
      border:0;
    }

    /* Quiz style (Ø³Ù‡Ù„ ÙˆØ¬Ù…ÙŠÙ„ + Ø£ØµÙˆØ§Øª) */
    .quizWrap{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .qmeta{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      color:#374151;
      font-weight:900;
      font-size:13px;
    }
    .progressPill{
      background:#f3f4ff;
      border:1px solid rgba(0,0,0,.06);
      padding:8px 10px;
      border-radius: 999px;
      font-weight:900;
    }
    .question{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius: 18px;
      padding:14px;
      box-shadow: 0 10px 20px rgba(0,0,0,.06);
    }
    .question h3{
      margin:0 0 10px;
      font-size:16px;
      font-weight:900;
    }
    .choices{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .choice{
      border:1px solid rgba(0,0,0,.10);
      border-radius: 14px;
      padding:12px 12px;
      cursor:pointer;
      font-weight:900;
      background:#fafafa;
      transition:.12s;
    }
    .choice:active{transform:scale(.99)}
    .choice.correct{border-color:#16a34a;background:#eafff0}
    .choice.wrong{border-color:#ef4444;background:#fff0f0}
    .quizBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:6px;
    }
    .smallbtn{
      border:none;
      cursor:pointer;
      padding:10px 12px;
      border-radius: 14px;
      font-weight:900;
      color:#fff;
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
    }
    .smallbtn.next{background:#111827}
    .smallbtn.restart{background:#b45309}
    .resultBox{
      text-align:center;
      font-weight:900;
      padding:12px;
      border-radius: 16px;
      background:#f3f4ff;
      border:1px solid rgba(0,0,0,.06);
    }

    /* Leaderboard + Parent */
    .panelGrid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(280px,1fr));
      gap:12px;
    }
    .panel{
      background:#fff;
      border-radius: 20px;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      border:1px solid rgba(0,0,0,.06);
      padding:14px;
    }
    .panel h3{margin:0 0 10px;font-size:16px;font-weight:900}
    .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:8px 0;
      border-bottom:1px dashed rgba(0,0,0,.10);
      font-weight:900;
      color:#374151;
    }
    .row:last-child{border-bottom:none}
    .tag{
      padding:6px 10px;
      border-radius:999px;
      background:#eef2ff;
      border:1px solid rgba(0,0,0,.06);
      font-size:12px;
      font-weight:900;
      color:#3730a3;
      white-space:nowrap;
    }
    .ok{color:#16a34a}
    .warn{color:#b45309}
    .danger{color:#ef4444}

    /* Image zoom modal */
    .zoomImg{
      width:100%;
      height:auto;
      border-radius: 18px;
      display:block;
    }

    @media (max-width:520px){
      .topbar{border-radius:0; margin:0 -14px; }
      .wrap{padding:0 0 18px}
      .screen{padding:0 14px}
      .btnRow{padding:12px}
      .bigbtn{flex:1}
      .skillBtn{width:100%; text-align:center}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>Ù…Ù‡Ø§Ø±Ø§Øª Ù„ØºØªÙŠ Ø§Ù„Ù…Ù…ØªØ¹Ø©</h1>
        <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‡Ø§Ø±Ø© Ø«Ù… Ø´Ø§Ù‡Ø¯ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.</p>
      </div>
      <div class="actions">
        <button class="chipbtn home" onclick="goHome()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="chipbtn secondary" onclick="openLeaderboard()">ğŸ† Ø§Ù„ØµØ¯Ø§Ø±Ø©</button>
        <button class="chipbtn secondary" onclick="openParent()">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</button>
      </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª -->
    <div id="skillsScreen" class="screen">
      <div class="hint">Ø§Ø®ØªØ± Ù…Ù‡Ø§Ø±Ø© Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± (20 Ù…Ù‡Ø§Ø±Ø©).</div>
      <div id="skillsGrid" class="skillsGrid"></div>

      <div class="panelGrid">
        <div class="panel">
          <h3>ğŸ– Ø§Ù„ØªÙ‚Ø¯Ù…</h3>
          <div class="row"><span>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</span><span class="tag" id="doneCount">0 / 20</span></div>
          <div class="row"><span>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</span><span class="tag" id="avgScore">0%</span></div>
          <div class="row"><span>Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©</span><span class="tag" id="bestScore">0%</span></div>
        </div>
        <div class="panel">
          <h3>ğŸ”” Ù…Ù„Ø§Ø­Ø¸Ø©</h3>
          <div style="color:#6b7280;font-weight:900;line-height:1.7">
            - Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù‡Ø§Ø±Ø© Ø³ØªØ¸Ù‡Ø± ØµÙˆØ±ØªÙ‡Ø§ Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± (ÙÙŠØ¯ÙŠÙˆ/Ø§Ø®ØªØ¨Ø§Ø±) ØªØ­ØªÙ‡Ø§.<br>
            - Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø² (Ù„Ù„ØµÙ/Ø§Ù„Ø¬ÙˆØ§Ù„).<br>
            - ÙŠÙ…ÙƒÙ† Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ù„Ø®Øµ Ù…Ù† Ø²Ø± (ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±).
          </div>
        </div>
      </div>

      <div class="footer">ØªØµÙ…ÙŠÙ…: ØµØ§Ù„Ø­Ø© Ø¹Ù„ÙŠ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ</div>
    </div>

    <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ø±Ø© -->
    <div id="viewer" class="screen viewer">
      <div class="skillCard">
        <div class="skillHeader">
          <div>
            <h2 id="skillTitle">Ø§Ù„Ù…Ù‡Ø§Ø±Ø©</h2>
            <div class="smallnote" id="skillSub">ØµÙˆØ±Ø© Ø´Ø±Ø­ + ÙÙŠØ¯ÙŠÙˆ + Ø§Ø®ØªØ¨Ø§Ø± (5 Ø£Ø³Ø¦Ù„Ø©)</div>
          </div>
          <div class="smallnote" id="skillStatus"></div>
        </div>

        <div class="skillImgWrap">
          <img id="skillImg" class="skillImg" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù‡Ø§Ø±Ø©" />
        </div>

        <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªØ­Øª Ø§Ù„ØµÙˆØ±Ø© (Ù…Ø«Ù„ Ù‚Ø¨Ù„) -->
        <div class="btnRow">
          <button class="bigbtn back" onclick="backToSkills()">â¬… Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…Ù‡Ø§Ø±Ø§Øª</button>
          <button class="bigbtn video" id="videoBtn">ğŸ¬ ÙÙŠØ¯ÙŠÙˆ</button>
          <button class="bigbtn quiz" id="quizBtn">ğŸ“ Ø§Ø®ØªØ¨Ø§Ø±</button>
        </div>
      </div>

      <div class="footer">ØªØµÙ…ÙŠÙ…: ØµØ§Ù„Ø­Ø© Ø¹Ù„ÙŠ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ</div>
    </div>
  </div>

  <!-- Modal Ø¹Ø§Ù… -->
  <div id="modalOverlay" class="modalOverlay" role="dialog" aria-modal="true">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modalTop">
        <b id="modalTitle">Ù†Ø§ÙØ°Ø©</b>
        <button class="closeBtn" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚ âœ–</button>
      </div>
      <div id="modalBody" class="modalBody"></div>
    </div>
  </div>

<script>
/* =========================
   Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª (20)
   ========================= */
const skills = [
  { id:"word_types",   name:"Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙƒÙ„Ù…Ø©", img:"image/skill_word_types.png", videos:["https://youtu.be/CvTvx1TRYw4?feature=shared"] },
  { id:"verb_types",   name:"Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ÙØ¹Ù„", img:"image/skill_verb-types.png", videos:["https://youtu.be/-fNt_5kOvIs?feature=shared"] },
  { id:"title",        name:"Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Øµ", img:"image/skill_title.png", videos:["https://youtu.be/KWRbbfoP20c?feature=shared","https://youtu.be/ZA0fn1a7VUg?feature=shared"] },
  { id:"tanween",      name:"Ø§Ù„ØªÙ†ÙˆÙŠÙ†", img:"image/skill_tanween.png", videos:["https://youtu.be/U3D7_jGq5NA?feature=shared"] },
  { id:"tafdeel",      name:"Ø§Ø³Ù… Ø§Ù„ØªÙØ¶ÙŠÙ„", img:"image/skill_tafdeel.png", videos:["https://youtu.be/pl5BGnN-Cdc?feature=shared"] },
  { id:"taa",          name:"Ø§Ù„ØªØ§Ø¡ Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© ÙˆØ§Ù„Ù‡Ø§Ø¡", img:"image/skill_taa-skills.png", videos:["https://youtu.be/R8fLZZjPZ6I?feature=shared"] },
  { id:"synonyms",     name:"Ø§Ù„Ù…Ø±Ø§Ø¯ÙØ§Øª", img:"image/skill_synonyms.png", videos:["https://youtu.be/Ue9sNE6oF98?feature=shared"] },
  { id:"sunmoon",      name:"Ø§Ù„Ù„Ø§Ù… Ø§Ù„Ø´Ù…Ø³ÙŠØ© ÙˆØ§Ù„Ù„Ø§Ù… Ø§Ù„Ù‚Ù…Ø±ÙŠØ©", img:"image/skill_sun-moon-lam.png", videos:["https://youtu.be/3-B4xd83GXw?feature=shared"] },
  { id:"sentence",     name:"Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ù…ÙÙŠØ¯Ø©", img:"image/skill_sentence.png", videos:["https://youtu.be/4NxjcMu9kV4?si=4qQ3a3gJmn24yYzo"] },
  { id:"punct",        name:"Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ±Ù‚ÙŠÙ…", img:"image/skill_punctuation.png", videos:["https://youtu.be/BpVqfG4LbCc?feature=shared"] },
  { id:"number",       name:"Ø§Ù„Ù…ÙØ±Ø¯ ÙˆØ§Ù„Ù…Ø«Ù†Ù‰ ÙˆØ§Ù„Ø¬Ù…Ø¹", img:"image/skill_number.png", videos:["https://youtu.be/fAdCP1qmLR0?feature=shared"] },
  { id:"mainidea",     name:"Ø§Ù„ÙÙƒØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³Ø©", img:"image/skill_main_idea.png", videos:["https://youtu.be/jhuaaQjiZIs?feature=shared"] },
  { id:"mad",          name:"Ø­Ø±ÙˆÙ Ø§Ù„Ù…Ø¯", img:"image/skill_mad-letters.png", videos:["https://youtu.be/MbTOjRgayT0?feature=shared"] },
  { id:"gender",       name:"Ø§Ù„Ù…Ø°ÙƒØ± ÙˆØ§Ù„Ù…Ø¤Ù†Ø«", img:"image/skill_gender.png", videos:["https://youtu.be/ufdUobvMz-E?feature=shared"] },
  { id:"activepassive",name:"Ø§Ù„Ù…Ø¨Ù†ÙŠ Ù„Ù„Ù…Ø¹Ù„ÙˆÙ… ÙˆØ§Ù„Ù…Ø¨Ù†ÙŠ Ù„Ù„Ù…Ø¬Ù‡ÙˆÙ„", img:"image/skill_active_passive.png", videos:["https://youtu.be/BgrU8E4PhGE?si=IELDSzT6zulwipKf"] },
  { id:"faelmafool",   name:"Ø§Ø³Ù… Ø§Ù„ÙØ§Ø¹Ù„ ÙˆØ§Ø³Ù… Ø§Ù„Ù…ÙØ¹ÙˆÙ„", img:"image/skill_fael-mafool.png", videos:["https://youtu.be/BgrU8E4PhGE?si=IELDSzT6zulwipKf"] },
  { id:"exception",    name:"Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡", img:"image/skill_exception.png", videos:["https://youtu.be/_l3t_vDpIJE?feature=shared"] },
  { id:"compare",      name:"Ø£ÙˆØ¬Ù‡ Ø§Ù„Ø´Ø¨Ù‡ ÙˆØ§Ù„Ø§Ø®ØªÙ„Ø§Ù", img:"image/skill_compare.png", videos:["https://youtu.be/ySR-1AgoQPY?feature=shared"] },
  { id:"antonyms",     name:"Ø§Ù„Ø£Ø¶Ø¯Ø§Ø¯", img:"image/skill_antonyms.png", videos:["https://youtu.be/kqTJtHz8U-Y?feature=shared"] },
  { id:"textparts",    name:"Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©", img:"image/skill_text_parts.png", videos:[] }
];

/* =========================
   Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Ù…Ø­Ù„ÙŠÙ‹Ø§)
   ========================= */
const STORE_KEY = "laghati_skills_progress_v1";
function loadStore(){
  try{ return JSON.parse(localStorage.getItem(STORE_KEY) || "{}"); }
  catch(e){ return {}; }
}
function saveStore(obj){
  localStorage.setItem(STORE_KEY, JSON.stringify(obj));
}

/* =========================
   Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
   ========================= */
const skillsScreen = document.getElementById("skillsScreen");
const skillsGrid = document.getElementById("skillsGrid");
const viewer = document.getElementById("viewer");
const skillTitleEl = document.getElementById("skillTitle");
const skillImgEl = document.getElementById("skillImg");
const skillStatusEl = document.getElementById("skillStatus");
const videoBtn = document.getElementById("videoBtn");
const quizBtn  = document.getElementById("quizBtn");

const doneCountEl = document.getElementById("doneCount");
const avgScoreEl  = document.getElementById("avgScore");
const bestScoreEl = document.getElementById("bestScore");

/* =========================
   Modal
   ========================= */
const modalOverlay = document.getElementById("modalOverlay");
const modalTitle = document.getElementById("modalTitle");
const modalBody  = document.getElementById("modalBody");

modalOverlay.addEventListener("click", closeModal); // Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© ÙŠØºÙ„Ù‚ (Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¬ÙˆØ§Ù„)

function openModal(title, html){
  modalTitle.textContent = title;
  modalBody.innerHTML = html;
  modalOverlay.classList.add("show");
  document.body.style.overflow="hidden";
}
function closeModal(){
  modalOverlay.classList.remove("show");
  modalBody.innerHTML = "";
  document.body.style.overflow="";
}

/* =========================
   ØªÙ†Ù‚Ù„
   ========================= */
function goHome(){
  window.location.href = "index.html";
}
function backToSkills(){
  viewer.classList.remove("show");
  skillsScreen.style.display = "";
  window.scrollTo({top:0, behavior:"smooth"});
}

/* =========================
   Ø£ØµÙˆØ§Øª (Ø¨Ø¯ÙˆÙ† Ù…Ù„ÙØ§Øª Ø®Ø§Ø±Ø¬ÙŠØ©)
   ========================= */
let audioCtx;
function beep(type){
  // type: "ok" | "bad" | "win"
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);

    const now = audioCtx.currentTime;

    if(type==="ok"){ o.frequency.setValueAtTime(660, now); g.gain.setValueAtTime(0.09, now); }
    if(type==="bad"){ o.frequency.setValueAtTime(220, now); g.gain.setValueAtTime(0.12, now); }
    if(type==="win"){ o.frequency.setValueAtTime(880, now); g.gain.setValueAtTime(0.10, now); }

    o.type="sine";
    o.start(now);
    o.stop(now + (type==="win" ? 0.18 : 0.12));
    g.gain.exponentialRampToValueAtTime(0.0001, now + (type==="win" ? 0.20 : 0.14));
  }catch(e){}
}

/* =========================
   Ø±Ø³Ù… Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª
   ========================= */
let currentSkill = null;

function renderSkillsButtons(){
  const store = loadStore();
  skillsGrid.innerHTML = "";

  skills.forEach(s=>{
    const btn = document.createElement("button");
    btn.className = "skillBtn";
    btn.textContent = s.name;

    const rec = store[s.id];
    if(rec && rec.bestScore >= 80){
      btn.style.border = "2px solid rgba(22,163,74,.55)";
    }

    btn.onclick = ()=> openSkill(s.id);
    skillsGrid.appendChild(btn);
  });

  updateProgressSummary();
}

function updateProgressSummary(){
  const store = loadStore();
  const scores = [];
  let done = 0;
  let best = 0;

  skills.forEach(s=>{
    const rec = store[s.id];
    if(rec && typeof rec.bestScore === "number"){
      scores.push(rec.bestScore);
      if(rec.bestScore >= 60) done++;
      if(rec.bestScore > best) best = rec.bestScore;
    }
  });

  const avg = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0) / scores.length) : 0;

  doneCountEl.textContent = `${done} / ${skills.length}`;
  avgScoreEl.textContent  = `${avg}%`;
  bestScoreEl.textContent = `${best}%`;
}

/* =========================
   ÙØªØ­ Ø§Ù„Ù…Ù‡Ø§Ø±Ø©
   ========================= */
function openSkill(id){
  const s = skills.find(x=>x.id===id);
  if(!s) return;
  currentSkill = s;

  // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ø±Ø¶
  skillsScreen.style.display = "none";
  viewer.classList.add("show");

  skillTitleEl.textContent = s.name;
  skillImgEl.src = s.img;

  // Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø±Ø¬Ø©
  const store = loadStore();
  const rec = store[s.id];
  const score = rec?.bestScore ?? 0;
  skillStatusEl.innerHTML = score
    ? `Ø£ÙØ¶Ù„ Ø¯Ø±Ø¬Ø©: <span class="tag">${score}%</span>`
    : `<span class="tag">Ù„Ù… ÙŠÙØ­Ù„ Ø¨Ø¹Ø¯</span>`;

  // Ø²Ø± ÙÙŠØ¯ÙŠÙˆ (Ù†Ø§ÙØ°Ø© ØµØºÙŠØ±Ø© Ù…Ø«Ù„ Ù‚Ø¨Ù„)
  videoBtn.onclick = ()=> openVideoModal(s);

  // Ø²Ø± Ø§Ø®ØªØ¨Ø§Ø± (Ù…Ø«Ù„ Ù‚Ø¨Ù„ + Ø£ØµÙˆØ§Øª)
  quizBtn.onclick = ()=> openQuizModal(s);

  // ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·
  skillImgEl.onclick = ()=> openModal("ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙˆØ±Ø©", `<img class="zoomImg" src="${s.img}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù‡Ø§Ø±Ø©">`);
  window.scrollTo({top:0, behavior:"smooth"});
}

/* =========================
   ÙÙŠØ¯ÙŠÙˆ (Modal ØµØºÙŠØ±)
   ========================= */
function youtubeToEmbed(url){
  // Ø¯Ø¹Ù… youtu.be Ùˆ youtube.com
  try{
    const u = new URL(url);
    let id = "";
    if(u.hostname.includes("youtu.be")){
      id = u.pathname.replace("/","");
    }else{
      id = u.searchParams.get("v") || "";
    }
    if(!id) return "";
    return `https://www.youtube.com/embed/${id}?autoplay=1&rel=0`;
  }catch(e){
    return "";
  }
}

function openVideoModal(skill){
  if(!skill.videos || skill.videos.length===0){
    openModal("ğŸ¬ ÙÙŠØ¯ÙŠÙˆ", `<div class="resultBox">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ø§Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`);
    return;
  }

  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù„Ù…Ù‡Ø§Ø±Ø© ÙÙŠØ¯ÙŠÙˆÙ‡ÙŠÙ† (Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Øµ)
  let buttons = "";
  if(skill.videos.length>1){
    buttons = `
      <div class="quizBtns" style="margin-bottom:10px">
        ${skill.videos.map((v,i)=>`<button class="smallbtn next" onclick="switchVideo('${youtubeToEmbed(v)}')">ÙÙŠØ¯ÙŠÙˆ ${i+1}</button>`).join("")}
      </div>
    `;
  }

  const firstEmbed = youtubeToEmbed(skill.videos[0]);
  openModal(`ğŸ¬ ÙÙŠØ¯ÙŠÙˆ â€” ${skill.name}`, `
    ${buttons}
    <div class="videoFrame">
      <iframe id="vidFrame" src="${firstEmbed}" allow="autoplay; encrypted-media" allowfullscreen></iframe>
    </div>
  `);
}

function switchVideo(embedUrl){
  const f = document.getElementById("vidFrame");
  if(f) f.src = embedUrl;
}

/* =========================
   Ø§Ø®ØªØ¨Ø§Ø± (5 Ø£Ø³Ø¦Ù„Ø©) + Ø£ØµÙˆØ§Øª + Ø­ÙØ¸ Ø¯Ø±Ø¬Ø©
   â€œÙ…Ø«Ù„ Ù‚Ø¨Ù„â€ Ø¨Ù…Ø¹Ù†Ù‰: Ù†Ø§ÙØ°Ø© + Ø®ÙŠØ§Ø±Ø§Øª + ØµØ­/Ø®Ø·Ø£ + Ø§Ù„ØªØ§Ù„ÙŠ
   ========================= */
function makeQuestionSet(skillName){
  // Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ø§Ù…Ø© Ø¨Ø³ÙŠØ·Ø© (ÙŠÙ…ÙƒÙ†Ùƒ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø¨Ù†Ùƒ Ø£Ø³Ø¦Ù„Ø© Ø­Ù‚ÙŠÙ‚ÙŠ Ù„ÙƒÙ„ Ù…Ù‡Ø§Ø±Ø©)
  // ÙƒÙ„ Ø³Ø¤Ø§Ù„: q, options, answerIndex
  // Ù†Ø¶Ø¹ Ø£Ø³Ø¦Ù„Ø© â€œØ¹Ø§Ù…Ø©â€ Ù„Ø·ÙŠÙØ© + Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù…Ù‡Ø§Ø±Ø© Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙ‚Ø·
  const base = [
    {q:`Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ù€ "${skillName}":`, options:["Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©","Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©","Ø§Ø®ØªÙŠØ§Ø± Ø«Ø§Ù„Ø«","Ø§Ø®ØªÙŠØ§Ø± Ø±Ø§Ø¨Ø¹"], a:0},
    {q:`Ø£ÙŠ Ø®ÙŠØ§Ø± ÙŠÙØ¹Ø¯Ù‘ Ø§Ù„Ø£ÙØ¶Ù„ ÙÙŠ "${skillName}"ØŸ`, options:["Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„","Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ","Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«","Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹"], a:1},
    {q:`Ø³Ø¤Ø§Ù„ ØªØ¯Ø±ÙŠØ¨ÙŠ: Ø­Ø¯Ù‘Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø£Ù‚Ø±Ø¨ Ù„Ù€ "${skillName}".`, options:["Ø£","Ø¨","Ø¬","Ø¯"], a:2},
    {q:`ØªØ§Ø¨Ø¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨: Ø§Ø®ØªØ± Ø§Ù„ØµØ­ÙŠØ­.`, options:["ØµØ­ÙŠØ­","Ø®Ø·Ø£","Ù„Ø§ Ø£Ø¯Ø±ÙŠ","ÙƒÙ„Ø§Ù‡Ù…Ø§"], a:0},
    {q:`Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø£Ø®ÙŠØ±: Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©.`, options:["1","2","3","4"], a:3},
  ];
  return base;
}

function openQuizModal(skill){
  const questions = makeQuestionSet(skill.name);

  let idx = 0;
  let locked = false;
  let score = 0;

  function render(){
    const total = questions.length;
    const q = questions[idx];

    openModal(`ğŸ“ Ø§Ø®ØªØ¨Ø§Ø± â€” ${skill.name}`, `
      <div class="quizWrap">
        <div class="qmeta">
          <div class="progressPill">Ø§Ù„Ø³Ø¤Ø§Ù„ ${idx+1} / ${total}</div>
          <div class="progressPill">Ø§Ù„Ø¯Ø±Ø¬Ø©: ${Math.round((score/total)*100)}%</div>
        </div>

        <div class="question">
          <h3>${q.q}</h3>
          <div class="choices">
            ${q.options.map((t,i)=>`<div class="choice" data-i="${i}">${t}</div>`).join("")}
          </div>
        </div>

        <div class="quizBtns">
          <button class="smallbtn restart" id="restartBtn">Ø¥Ø¹Ø§Ø¯Ø©</button>
          <button class="smallbtn next" id="nextBtn">${idx===total-1 ? "Ø¥Ù†Ù‡Ø§Ø¡" : "Ø§Ù„ØªØ§Ù„ÙŠ"}</button>
        </div>

        <div id="msg" class="resultBox" style="display:none"></div>
      </div>
    `);

    // handlers
    locked = false;

    const choiceEls = [...modalBody.querySelectorAll(".choice")];
    choiceEls.forEach(el=>{
      el.addEventListener("click", ()=>{
        if(locked) return;
        locked = true;

        const i = Number(el.getAttribute("data-i"));
        const correct = (i === q.a);

        // ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµØ­/Ø§Ù„Ø®Ø·Ø£
        choiceEls.forEach(c=>{
          const ci = Number(c.getAttribute("data-i"));
          if(ci === q.a) c.classList.add("correct");
          if(ci === i && ci !== q.a) c.classList.add("wrong");
        });

        const msg = modalBody.querySelector("#msg");
        msg.style.display = "block";
        if(correct){
          score++;
          beep("ok");
          msg.innerHTML = `âœ… Ø£Ø­Ø³Ù†Øª! Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©.`;
          msg.className = "resultBox";
        }else{
          beep("bad");
          msg.innerHTML = `âŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰â€¦ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…Ù„ÙˆÙ‘Ù†Ø© Ø¨Ø§Ù„Ø£Ø®Ø¶Ø±.`;
          msg.className = "resultBox";
        }
      });
    });

    modalBody.querySelector("#restartBtn").onclick = ()=>{
      idx = 0; score = 0; beep("bad");
      render();
    };

    modalBody.querySelector("#nextBtn").onclick = ()=>{
      // Ù„Ø§ Ù†Ù…Ù†Ø¹ Ø§Ù„ØªØ§Ù„ÙŠ (Ù…Ø«Ù„ Ù‚Ø¨Ù„ ÙƒØ§Ù† ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ØºØ§Ù„Ø¨Ù‹Ø§)
      if(idx < total-1){
        idx++;
        render();
      }else{
        // Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        const percent = Math.round((score/total)*100);
        saveBestScore(skill.id, percent);
        beep("win");

        openModal(`âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± â€” ${skill.name}`, `
          <div class="resultBox">
            Ù†ØªÙŠØ¬ØªÙƒ: <span class="tag">${percent}%</span><br><br>
            ğŸ† Ø§Ø³ØªÙ…Ø±ÙŠ! ÙƒÙ„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙØ­Ø³Ù‘Ù† Ù…Ø³ØªÙˆØ§Ùƒ.
          </div>
          <div class="quizBtns" style="margin-top:12px">
            <button class="smallbtn next" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
            <button class="smallbtn restart" onclick="openQuizModal(currentSkill)">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
          </div>
        `);

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
        updateProgressSummary();
        if(currentSkill && currentSkill.id === skill.id){
          const store = loadStore();
          const rec = store[skill.id];
          skillStatusEl.innerHTML = `Ø£ÙØ¶Ù„ Ø¯Ø±Ø¬Ø©: <span class="tag">${rec.bestScore}%</span>`;
        }
      }
    };
  }

  render();
}

function saveBestScore(skillId, percent){
  const store = loadStore();
  const old = store[skillId]?.bestScore ?? 0;
  const best = Math.max(old, percent);
  store[skillId] = { bestScore: best, lastScore: percent, updatedAt: Date.now() };
  saveStore(store);
}

/* =========================
   Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© (Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ø¬Ù‡Ø§Ø²)
   ========================= */
function openLeaderboard(){
  const store = loadStore();
  const rows = skills
    .map(s=>{
      const best = store[s.id]?.bestScore ?? 0;
      return {name:s.name, best};
    })
    .sort((a,b)=> b.best - a.best);

  const html = `
    <div class="panel">
      <h3>ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© (Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²)</h3>
      ${rows.map((r,i)=>{
        const color = r.best>=80 ? "ok" : r.best>=60 ? "warn" : "danger";
        return `<div class="row">
          <span>${i+1}) ${r.name}</span>
          <span class="tag ${color}">${r.best}%</span>
        </div>`;
      }).join("")}
    </div>
    <div class="resultBox" style="margin-top:10px">
      ğŸ’¡ Ù‡Ø°Ù‡ Ø§Ù„ØµØ¯Ø§Ø±Ø© ØªÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø² (Ø§Ù„Ø³Ø¨ÙˆØ±Ø©/Ø§Ù„Ø¬ÙˆØ§Ù„).
    </div>
  `;
  openModal("ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©", html);
}

/* =========================
   ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ù…Ù„Ø®Øµ)
   ========================= */
function openParent(){
  const store = loadStore();
  const scores = [];
  let done = 0;
  let best = 0;

  skills.forEach(s=>{
    const rec = store[s.id];
    if(rec && typeof rec.bestScore === "number"){
      scores.push(rec.bestScore);
      if(rec.bestScore >= 60) done++;
      if(rec.bestScore > best) best = rec.bestScore;
    }
  });

  const avg = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : 0;

  const html = `
    <div class="panel">
      <h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ØªÙ‚Ø±ÙŠØ± ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</h3>
      <div class="row"><span>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</span><span class="tag">${skills.length}</span></div>
      <div class="row"><span>Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø© (â‰¥ 60%)</span><span class="tag">${done}</span></div>
      <div class="row"><span>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</span><span class="tag">${avg}%</span></div>
      <div class="row"><span>Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©</span><span class="tag">${best}%</span></div>
    </div>

    <div class="panel" style="margin-top:12px">
      <h3>âœ… ØªÙˆØµÙŠØ© Ø³Ø±ÙŠØ¹Ø©</h3>
      <div style="color:#6b7280;font-weight:900;line-height:1.7">
        - Ø´Ø¬Ù‘Ø¹ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø­ØªÙ‰ ÙŠØµÙ„ Ø¥Ù„Ù‰ <b>80%</b> ÙØ£ÙƒØ«Ø±.<br>
        - Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø§Ø¹Ø¯ Ø¹Ù„Ù‰ Ø±ÙØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø©.<br>
        - ÙŠÙ…ÙƒÙ† ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ­Ø³Ù‘Ù†.
      </div>
    </div>
  `;
  openModal("ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±", html);
}

/* =========================
   ØªØ´ØºÙŠÙ„
   ========================= */
function init(){
  renderSkillsButtons();
}
init();
</script>
</body>
</html>
